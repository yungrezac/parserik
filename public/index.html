
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB Parser</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f0f2f5; color: #333; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #5a3a96; text-align: center; }
        .input-group, .selection-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="text"], input[type="search"] { width: calc(100% - 22px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        button { background-color: #7d5ab8; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; display: block; width: 100%; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #5a3a96; }
        .columns-container { display: flex; gap: 20px; }
        .category-column, .subcategory-column { width: 50%; }
        .search-box { margin-bottom: 10px; }
        .list-box { height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 5px; }
        .list-item { padding: 8px 12px; cursor: pointer; border-radius: 4px; margin: 2px 0; }
        .list-item:hover { background-color: #f0e6ff; }
        .list-item.selected { background-color: #7d5ab8; color: white; }
        .list-item.disabled { color: #aaa; cursor: not-allowed; font-style: italic; }
        .progress-container { margin-top: 20px; }
        #progress-bar-container { background-color: #e0e0e0; border-radius: 4px; overflow: hidden; height: 25px; }
        #progress-bar { width: 0%; height: 100%; background-color: #7d5ab8; transition: width 0.2s; }
        #progress-text, #log-text { text-align: center; margin-top: 8px; font-size: 14px; color: #555; }
        #download-link-container { margin-top: 20px; text-align: center; }
        #download-link { display: inline-block; background-color: #4CAF50; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>WB Parser</h1>

    <!-- Step 1: Input Seller and Brand IDs -->
    <div class="input-group">
        <label for="seller-id">ID Продавца</label>
        <input type="text" id="seller-id" placeholder="Введите ID продавца">
    </div>
    <div class="input-group">
        <label for="brand-id">ID Бренда</label>
        <input type="text" id="brand-id" placeholder="Введите ID бренда">
    </div>

    <!-- Step 2: Select Category and Subcategory -->
    <div class="selection-group">
        <h2>Выбор категории</h2>
        <div class="columns-container">
            <div class="category-column">
                <label for="category-search">Поиск категории</label>
                <input type="search" id="category-search" class="search-box" placeholder="Начните вводить для поиска...">
                <div id="category-list" class="list-box"></div>
            </div>
            <div class="subcategory-column">
                <label for="subcategory-search">Поиск подкатегории</label>
                <input type="search" id="subcategory-search" class="search-box" placeholder="Начните вводить для поиска...">
                <div id="subcategory-list" class="list-box"></div>
            </div>
        </div>
    </div>

    <!-- Step 3: Parse Button -->
    <button id="parse-btn" disabled>Запустить парсинг</button>

    <!-- Progress and Result -->
    <div id="progress-container" class="progress-container hidden">
        <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
        <div id="progress-text"></div>
        <div id="log-text"></div>
        <div id="download-link-container" class="hidden">
            <a id="download-link" href="#" download>Скачать результат</a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- DOM Elements ---
    const sellerIdInput = document.getElementById('seller-id');
    const brandIdInput = document.getElementById('brand-id');
    const categorySearch = document.getElementById('category-search');
    const subcategorySearch = document.getElementById('subcategory-search');
    const categoryList = document.getElementById('category-list');
    const subcategoryList = document.getElementById('subcategory-list');
    const parseBtn = document.getElementById('parse-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const logText = document.getElementById('log-text');
    const downloadLinkContainer = document.getElementById('download-link-container');
    const downloadLink = document.getElementById('download-link');

    // --- State ---
    let categoriesData = {};
    let selectedCategory = null;
    let selectedSubcategory = null;

    // --- Functions ---
    const fetchCategories = async () => {
        try {
            const response = await fetch('/categories');
            if (!response.ok) throw new Error('Network response was not ok');
            categoriesData = await response.json();
            renderCategories();
        } catch (error) {
            console.error("Ошибка при загрузке категорий:", error);
            categoryList.innerHTML = '<p style="color: red;">Не удалось загрузить категории.</p>';
        }
    };

    const renderCategories = (filter = '') => {
        categoryList.innerHTML = '';
        const filteredKeys = Object.keys(categoriesData).filter(cat => cat.toLowerCase().includes(filter.toLowerCase()));
        
        filteredKeys.forEach(cat => {
            const hasSubcategories = Object.keys(categoriesData[cat]).length > 0;
            const item = document.createElement('div');
            item.className = 'list-item';
            item.textContent = cat;
            if (!hasSubcategories) {
                item.classList.add('disabled');
                item.title = 'В этой категории нет подкатегорий';
            } else {
                item.onclick = () => selectCategory(cat);
            }
            categoryList.appendChild(item);
        });
    };

    const selectCategory = (category) => {
        selectedCategory = category;
        selectedSubcategory = null;
        
        // Update UI for category list
        document.querySelectorAll('#category-list .list-item').forEach(item => {
            item.classList.toggle('selected', item.textContent === category);
        });

        renderSubcategories();
        updateParseButtonState();
    };

    const renderSubcategories = (filter = '') => {
        subcategoryList.innerHTML = '';
        if (!selectedCategory || !categoriesData[selectedCategory]) return;

        const subcategories = categoriesData[selectedCategory];
        const filteredKeys = Object.keys(subcategories).filter(sub => sub.toLowerCase().includes(filter.toLowerCase()));

        filteredKeys.forEach(sub => {
            const hasColumns = Array.isArray(subcategories[sub]) && subcategories[sub].length > 0;
            const item = document.createElement('div');
            item.className = 'list-item';
            item.textContent = sub;
            if (!hasColumns) {
                item.classList.add('disabled');
                item.title = 'Для этой подкатегории не заданы столбцы для парсинга';
            } else {
                item.onclick = () => selectSubcategory(sub);
            }
            subcategoryList.appendChild(item);
        });
    };

    const selectSubcategory = (subcategory) => {
        selectedSubcategory = subcategory;
        
        // Update UI for subcategory list
        document.querySelectorAll('#subcategory-list .list-item').forEach(item => {
            item.classList.toggle('selected', item.textContent === subcategory);
        });
        
        updateParseButtonState();
    };

    const updateParseButtonState = () => {
        const sellerId = sellerIdInput.value.trim();
        const brandId = brandIdInput.value.trim();
        parseBtn.disabled = !(sellerId && brandId && selectedCategory && selectedSubcategory);
    };

    const startParsing = () => {
        const sellerId = sellerIdInput.value.trim();
        const brandId = brandIdInput.value.trim();
        const category = selectedCategory;
        const subcategory = selectedSubcategory;

        if (!sellerId || !brandId || !category || !subcategory) {
            alert("Пожалуйста, заполните все поля и выберите категорию/подкатегорию.");
            return;
        }

        // Reset UI
        parseBtn.disabled = true;
        progressContainer.classList.remove('hidden');
        downloadLinkContainer.classList.add('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = '';
        logText.textContent = 'Инициализация...';

        const url = `/stream?seller_id=${encodeURIComponent(sellerId)}&brand_id=${encodeURIComponent(brandId)}&category=${encodeURIComponent(category)}&subcategory=${encodeURIComponent(subcategory)}`;
        const eventSource = new EventSource(url);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            switch(data.type) {
                case 'start':
                    logText.textContent = data.message;
                    break;
                case 'progress':
                    const percentage = (data.current / data.total) * 100;
                    progressBar.style.width = percentage + '%';
                    progressText.textContent = `${data.current} / ${data.total} - ${data.message}`;
                    break;
                case 'log':
                    logText.textContent = data.message;
                    break;
                case 'result':
                    logText.textContent = "Парсинг завершен!";
                    progressBar.style.width = '100%';
                    downloadLink.href = `/download/${data.download_filename}`;
                    downloadLink.textContent = `Скачать ${data.download_filename}`;
                    downloadLinkContainer.classList.remove('hidden');
                    eventSource.close();
                    parseBtn.disabled = false;
                    break;
                case 'error':
                    logText.textContent = `Ошибка: ${data.message}`;
                    logText.style.color = 'red';
                    eventSource.close();
                    parseBtn.disabled = false;
                    break;
            }
        };

        eventSource.onerror = function() {
            logText.textContent = 'Ошибка соединения с сервером.';
            logText.style.color = 'red';
            eventSource.close();
            parseBtn.disabled = false;
        };
    };

    // --- Event Listeners ---
    [sellerIdInput, brandIdInput].forEach(input => input.addEventListener('input', updateParseButtonState));
    categorySearch.addEventListener('input', () => renderCategories(categorySearch.value));
    subcategorySearch.addEventListener('input', () => renderSubcategories(subcategorySearch.value));
    parseBtn.addEventListener('click', startParsing);

    // --- Initial Load ---
    fetchCategories();
});
</script>

</body>
</html>
