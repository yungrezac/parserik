
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WB Parser</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f4f4f5);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #9e9e9e);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-destructive: var(--tg-theme-destructive-text-color, #ff3b30);

            --button-gradient: linear-gradient(135deg, #007aff, #5856d6);
            --button-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            margin: 0;
            padding: 15px;
            -webkit-font-smoothing: antialiased;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Use full viewport height */
            box-sizing: border-box; /* Include padding in height calculation */
            overflow: hidden;
        }

        .container { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        
        .step {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0; /* Critical for scrolling */
            animation: fadeIn 0.4s ease-in-out;
        }

        .step.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin: 0 0 20px 0;
            padding: 5px 0;
        }
        
        .input-group { margin-bottom: 25px; }

        input[type="text"], input[type="search"] {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
            box-sizing: border-box;
            transition: box-shadow 0.2s;
        }
        input::placeholder { color: var(--tg-hint); }
        input:focus { outline: none; box-shadow: 0 0 0 2px var(--tg-link); }

        .list-container {
            flex-grow: 1;
            min-height: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px; /* Space between cards */
            padding-bottom: 5px; /* some breathing room at the bottom */
        }

        .list-item {
            background-color: var(--tg-secondary-bg);
            padding: 14px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 17px;
            transition: transform 0.15s ease;
            flex-shrink: 0; /* Prevent items from shrinking */
        }
        .list-item:active {
             transform: scale(0.98);
        }
        .list-item.selected { 
            background-color: var(--tg-link);
            color: var(--tg-button-text);
            font-weight: 500;
         }
        .list-item.disabled { 
            color: var(--tg-hint);
            cursor: not-allowed;
            background-color: color-mix(in srgb, var(--tg-secondary-bg), var(--tg-bg) 50%);
        }

        #summary-content { background: var(--tg-secondary-bg); padding: 20px; border-radius: 12px; }
        #summary-content p { margin: 0 0 12px; font-size: 16px; }
        #summary-content p:last-child { margin-bottom: 0; }
        #summary-content span { font-weight: 600; color: var(--tg-text); float: right; }

        #step-progress { text-align: center; justify-content: center; }
        #progress-header { font-size: 22px; margin-bottom: 15px; }
        #progress-bar-container { background-color: var(--tg-secondary-bg); border-radius: 8px; overflow: hidden; height: 12px; margin: 25px 0; }
        #progress-bar { width: 0%; height: 100%; background-image: var(--button-gradient); transition: width 0.3s; border-radius: 8px; }
        #log-text, #progress-text { font-size: 15px; color: var(--tg-hint); }
        #download-button {
            display: inline-block;
            background-image: var(--button-gradient);
            color: var(--tg-button-text);
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 12px;
            margin-top: 30px;
            font-weight: 600;
            font-size: 17px;
            border: none;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s;
        }
        #download-button:active { transform: scale(0.97); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="step1" class="step active"> 
        <h1>Шаг 1: ID Продавца</h1>
        <div class="input-group"> 
            <input type="text" id="seller-id" placeholder="Введите ID продавца"> 
        </div>
    </div>
    <div id="step2" class="step">
        <h1>Шаг 2: Категория</h1>
        <input type="search" id="category-search" placeholder="Поиск категории...">
        <div id="category-list" class="list-container"></div>
    </div>
    <div id="step3" class="step">
        <h1>Шаг 3: Подкатегория</h1>
        <input type="search" id="subcategory-search" placeholder="Поиск подкатегории...">
        <div id="subcategory-list" class="list-container"></div>
    </div>
    <div id="step4" class="step">
        <h1>Шаг 4: ID Бренда (опционально)</h1>
        <div class="input-group">
            <input type="text" id="brand-id" placeholder="Можно оставить пустым">
        </div>
    </div>
    <div id="step5" class="step">
        <h1>Шаг 5: Подтверждение</h1>
        <div id="summary-content">
            <p>Продавец: <span id="summary-seller-id"></span></p>
            <p>Категория: <span id="summary-category"></span></p>
            <p>Подкатегория: <span id="summary-subcategory"></span></p>
            <p>Бренд: <span id="summary-brand-id"></span></p>
        </div>
    </div>
    <div id="step-progress" class="step">
        <h1 id="progress-header"></h1>
        <div id="progress-bar-container"><div id="progress-bar"></div></div>
        <p id="progress-text"></p>
        <p id="log-text"></p>
        <button id="download-button" class="hidden"></button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const webApp = window.Telegram.WebApp;
    webApp.ready();
    webApp.expand();

    const state = { currentStep: 1, categoriesData: {}, sellerId: '', brandId: '', category: '', subcategory: '', xsubjectId: '' };
    
    const ui = {
        steps: {
            1: document.getElementById('step1'), 2: document.getElementById('step2'),
            3: document.getElementById('step3'), 4: document.getElementById('step4'),
            5: document.getElementById('step5'), progress: document.getElementById('step-progress')
        },
        inputs: {
            sellerId: document.getElementById('seller-id'), brandId: document.getElementById('brand-id'),
            categorySearch: document.getElementById('category-search'), subcategorySearch: document.getElementById('subcategory-search')
        },
        lists: { category: document.getElementById('category-list'), subcategory: document.getElementById('subcategory-list') },
        summary: {
            sellerId: document.getElementById('summary-seller-id'), brandId: document.getElementById('summary-brand-id'),
            category: document.getElementById('summary-category'), subcategory: document.getElementById('summary-subcategory')
        },
        progress: {
            header: document.getElementById('progress-header'), bar: document.getElementById('progress-bar'),
            text: document.getElementById('progress-text'), log: document.getElementById('log-text'),
            downloadBtn: document.getElementById('download-button')
        }
    };

    const goToStep = (step) => {
        if (!ui.steps[step]) return;
        state.currentStep = step;
        Object.values(ui.steps).forEach(s => s.classList.remove('active'));
        ui.steps[step].classList.add('active');
        updateMainButton();
        step > 1 && step !== 'progress' ? webApp.BackButton.show() : webApp.BackButton.hide();
    };

    const updateMainButton = () => {
        const buttonText = 'Далее', skipText = 'Пропустить', startText = 'Запустить';
        let isEnabled = false;

        switch(state.currentStep) {
            case 1: isEnabled = ui.inputs.sellerId.value.trim(); webApp.MainButton.setText(buttonText); break;
            case 2: isEnabled = state.category; webApp.MainButton.setText(buttonText); break;
            case 3: isEnabled = state.xsubjectId; webApp.MainButton.setText(buttonText); break;
            case 4: isEnabled = true; webApp.MainButton.setText(ui.inputs.brandId.value.trim() ? buttonText : skipText); break;
            case 5: isEnabled = true; webApp.MainButton.setText(startText); break;
            default: webApp.MainButton.hide(); return;
        }

        webApp.MainButton.show();
        isEnabled ? webApp.MainButton.enable().setParams({ color: 'var(--tg-theme-button-color)' }) : webApp.MainButton.disable().setParams({ color: '#a8a8a8' });
    };

    webApp.onEvent('mainButtonClicked', () => {
        switch(state.currentStep) {
            case 1: state.sellerId = ui.inputs.sellerId.value.trim(); goToStep(2); break;
            case 2: renderList(ui.lists.subcategory, state.categoriesData[state.category], 'subcategory'); goToStep(3); break;
            case 3: goToStep(4); break;
            case 4: 
                state.brandId = ui.inputs.brandId.value.trim();
                ui.summary.sellerId.textContent = state.sellerId;
                ui.summary.category.textContent = state.category;
                ui.summary.subcategory.textContent = state.subcategory;
                ui.summary.brandId.textContent = state.brandId || 'Все бренды';
                goToStep(5);
                break;
            case 5: startParsing(); break;
        }
    });

    webApp.onEvent('backButtonClicked', () => {
        if (state.currentStep === 3) { 
            state.subcategory = null;
            state.xsubjectId = null;
            selectItem('category', state.category); 
        }
        goToStep(state.currentStep - 1)
    });

    Object.values(ui.inputs).forEach(el => el.addEventListener('input', updateMainButton));

    const fetchCategories = async () => {
        try {
            const response = await fetch('/categories');
            state.categoriesData = await response.json();
            renderList(ui.lists.category, Object.keys(state.categoriesData), 'category');
        } catch (e) { console.error("Ошибка загрузки категорий"); }
    };

    const renderList = (element, items, type, filter = '') => {
        element.innerHTML = '';
        const itemKeys = (type === 'category' ? items : Object.keys(items || {}));
        const filteredItems = itemKeys.filter(i => i.toLowerCase().includes(filter.toLowerCase()));

        if (filteredItems.length === 0) {
            const placeholder = document.createElement('div');
            placeholder.textContent = 'Ничего не найдено';
            placeholder.style.textAlign = 'center';
            placeholder.style.padding = '20px';
            placeholder.style.color = 'var(--tg-hint)';
            element.appendChild(placeholder);
            return;
        }

        filteredItems.forEach(item => {
            let isDisabled = false, title = '';
            let subcatId = null;
            if (type === 'category') {
                isDisabled = Object.keys(state.categoriesData[item] || {}).length === 0;
                title = 'Нет подкатегорий';
            } else if (type === 'subcategory') {
                subcatId = items[item];
                isDisabled = !subcatId;
                title = 'Парсинг для этой подкатегории не настроен';
            }
            const el = document.createElement('div');
            el.className = 'list-item';
            el.textContent = item;
            el.dataset.id = item;
            if (isDisabled) {
                el.classList.add('disabled');
                el.title = title;
            } else {
                el.onclick = () => selectItem(type, item, subcatId);
            }
            if ((type === 'category' && state.category === item) || (type === 'subcategory' && state.subcategory === item)) {
                el.classList.add('selected');
            }
            element.appendChild(el);
        });
    };

    const selectItem = (type, value, id = null) => {
        if (type === 'category') {
            state.category = value; 
            state.subcategory = null;
            state.xsubjectId = null;
        } else {
            state.subcategory = value;
            state.xsubjectId = id;
        }
        document.querySelectorAll(`#${type}-list .list-item`).forEach(c => c.classList.toggle('selected', c.dataset.id === value));
        updateMainButton();
    };

    ui.inputs.categorySearch.addEventListener('input', (e) => renderList(ui.lists.category, Object.keys(state.categoriesData), 'category', e.target.value));
    ui.inputs.subcategorySearch.addEventListener('input', (e) => {
        if (!state.category) return;
        renderList(ui.lists.subcategory, state.categoriesData[state.category], 'subcategory', e.target.value);
    });

    const startParsing = () => {
        goToStep('progress');
        Object.values(ui.progress).forEach(el => el.classList.add('hidden'));
        ui.progress.header.classList.remove('hidden');
        
        const params = new URLSearchParams({ seller_id: state.sellerId });
        if (state.brandId) params.append('brand_id', state.brandId);
        if (state.xsubjectId) params.append('xsubject_id', state.xsubjectId);

        const es = new EventSource(`/stream?${params.toString()}`);
        const resetUI = () => {
            webApp.MainButton.setText('Начать заново').show().enable();
            webApp.MainButton.onClick(() => window.location.reload());
            webApp.BackButton.hide();
        }

        es.onmessage = (e) => {
            const data = JSON.parse(e.data);
            [ui.progress.bar.parentElement, ui.progress.text, ui.progress.log].forEach(el => el.classList.remove('hidden'));

            switch(data.type) {
                case 'start': ui.progress.header.textContent = `Найдено: ${data.total} товаров`; ui.progress.log.textContent = data.message; break;
                case 'progress':
                    ui.progress.bar.style.width = `${(data.current / data.total) * 100}%`;
                    ui.progress.text.textContent = `${data.current} / ${data.total}`;
                    ui.progress.log.textContent = data.message;
                    break;
                case 'log': ui.progress.log.textContent = data.message; break;
                case 'result':
                    ui.progress.header.textContent = 'Готово!';
                    ui.progress.log.textContent = 'Файл успешно создан.';
                    ui.progress.downloadBtn.classList.remove('hidden');
                    ui.progress.downloadBtn.textContent = `Скачать Excel`;
                    ui.progress.downloadBtn.onclick = () => webApp.openLink(`/download/${data.download_filename}`);
                    es.close(); resetUI();
                    break;
                case 'error':
                    ui.progress.header.textContent = 'Ошибка';
                    ui.progress.log.textContent = data.message;
                    ui.progress.log.style.color = 'var(--tg-destructive)';
                    es.close(); resetUI();
                    break;
            }
        };
        es.onerror = () => { 
            ui.progress.header.textContent = 'Ошибка сети';
            ui.progress.log.textContent = 'Потеряно соединение с сервером.';
            es.close(); resetUI();
        };
    };

    fetchCategories();
    updateMainButton();
});
</script>

</body>
</html>
